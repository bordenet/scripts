# AI Agent Guidelines

> **Auto-generated by Golden Agents Framework** | [superpowers-plus/guidance](https://github.com/bordenet/superpowers-plus)

---

## Superpowers Bootstrap

At the START of every conversation, run:

```bash
node ~/.codex/superpowers-augment/superpowers-augment.js bootstrap
```

**Key skills to invoke:**
| Skill | When to Use |
|-------|-------------|
| `superpowers:brainstorming` | Before creative/feature work |
| `superpowers:systematic-debugging` | Before fixing bugs |
| `superpowers:test-driven-development` | Before writing implementation |
| `superpowers:verification-before-completion` | Before claiming done |

---

## Communication Standards

### Banned Phrases
| AI Tells | leverage, utilize, facilitate, streamline, optimize |
| Filler | It's important to note, It's worth mentioning, Interestingly |
| Sycophancy | Great question!, Happy to help!, Excellent point! |

### Evidence-Based Claims
Every claim requires evidence. No unsubstantiated assertions.

---

## Quality Gates

**Before ANY commit:**
```bash
shellcheck *.sh
bash -n *.sh
```

---

## Context Management

- **Context rot**: Model accuracy degrades as context fills. Keep tokens high-signal.
- **Progressive disclosure**: Load Agents.md always, modules on-demand, code just-in-time.
- **At 75% context**: Summarize conversation history, drop low-value context.
- **Session resumption**: Check `git status`, `git log -5`, load notes before proceeding.

---

## Project-Specific Guidelines

# AI Agent Guidelines for This Repository

This document contains project-specific guidelines and lessons learned for Claude Code when working in this repository.

**CRITICAL**: This document supplements [STYLE_GUIDE.md](./STYLE_GUIDE.md). Read both documents before making any changes.

## Repository Status

**All 80+ scripts in this repository are 100% compliant with our coding standards.**

### Current Compliance Metrics

- ✅ **Zero ShellCheck warnings** - All scripts pass `shellcheck -S warning`
- ✅ **Zero syntax errors** - All scripts validated with `bash -n`
- ✅ **Correct shebang** - All scripts use `#!/usr/bin/env bash`
- ✅ **Error handling** - All scripts use `set -euo pipefail` (except bu.sh/mu.sh)
- ✅ **Line limits** - No script exceeds 400 lines
- ✅ **Help documentation** - All scripts implement `-h/--help` with man-page style output
- ✅ **Dry-run support** - All destructive scripts implement `--what-if` flag
- ✅ **Pre-commit hook** - Automated quality gate installed and enforced

**Last validated:** 2025-11-25

---

## Quick Start for AI Assistants

Before making any changes:

1. ✅ Read [STYLE_GUIDE.md](./STYLE_GUIDE.md) - Authoritative coding standards
2. ✅ Read this document (Agents.md) - Platform-specific gotchas and workflows
3. ✅ Check [docs/](./docs/) - Script-specific documentation

**Golden Rule**: When in doubt, consult STYLE_GUIDE.md. It is the source of truth.

**Maintain 100% Compliance**: All new scripts and changes must meet the standards above. The pre-commit hook will enforce this automatically.

---

## User Environment

- **All hardware is Apple Silicon** (ARM64 architecture)
- Homebrew paths: `/opt/homebrew/` (not `/usr/local/`)
- When suggesting paths, always use Apple Silicon defaults first
- **macOS uses BSD tools, not GNU** - always test awk/sed/grep syntax
  - BSD awk does NOT support `match()` with array capture
  - Use `grep | sed` pipelines instead of complex awk
  - Test all regex/text processing commands before committing
  - See [STYLE_GUIDE.md § Platform Compatibility](./STYLE_GUIDE.md#platform-compatibility) for details

## Quality Standards for Code Delivery

### Pre-Commit Requirements

**MANDATORY**: All code changes MUST be tested, validated, and linted before committing. No exceptions.

### Standard Pre-Commit Checklist

**CRITICAL: You MUST complete ALL steps before committing. Skipping verification = broken code in production.**

1. **Verify STYLE_GUIDE.md compliance - DO THIS FIRST**
   - **VERIFY**: Script has `-h/--help` flag that displays man-page style help
   - **VERIFY**: Script has `-v/--verbose` flag that shows INFO-level logs
   - **VERIFY**: Destructive scripts have `--what-if` flag for dry-run mode
   - **VERIFY**: Script uses `set -euo pipefail` (except bu.sh/mu.sh)
   - **VERIFY**: Script is under 400 lines
   - **VERIFY**: ShellCheck passes with zero warnings: `shellcheck -S warning script.sh`
   - **If ANY of these fail, STOP and fix before proceeding**

2. **Lint the code**
   - Run shellcheck for bash scripts: `shellcheck -S warning script.sh`
   - Run appropriate linter for the language
   - Fix all warnings that aren't explicitly false positives
   - **VERIFY**: `shellcheck -S warning script.sh` returns no output
   - Target: zero linting errors/warnings before commit

3. **Test the code - MANDATORY**
   - **RUN THE SCRIPT**: Actually execute it, don't just read it
   - For scripts: `./script.sh --help` at minimum
   - **VERIFY**: `./script.sh --verbose` works and shows INFO-level logs
   - For libraries: Source them in a test shell and call functions
   - Test with sample data before committing
   - Test awk/sed/grep commands in isolation: `echo "sample" | command`
   - **VERIFY**: Script runs without errors for basic operations
   - If adding features: Test the new feature works
   - If fixing bugs: Verify the bug is actually fixed
   - If you can't test on the target platform, explicitly document this AND don't commit

4. **Validate the code**
   - **VERIFY**: `bash -n script.sh` returns no errors
   - **VERIFY**: All sourced files exist: `test -f lib/sourced-file.sh`
   - **VERIFY**: All required commands available: `command -v required_command`
   - Test with edge cases (empty inputs, special characters, etc.)

5. **Verify variable exports - CRITICAL FOR LIBRARIES**
   - If library uses variables from calling script, **VERIFY** they're exported
   - Check for `set -u` (unbound variable) errors
   - **TEST**: Source the library and call functions to catch missing exports
   - **Example test**:
     ```bash
     # Create minimal test environment
     bash -c 'export VAR1=val1 VAR2=val2; source lib/file.sh; function_name'
     # If this fails with "unbound variable", you're missing an export
     ```

6. **Handle edge cases**
   - Filenames with spaces/special characters
   - Empty inputs
   - Command failures
   - Concurrent execution (file locking where needed)

7. **Error handling**
   - Check return codes
   - Don't mask errors with `local var=$(cmd)` without checking
   - Provide actionable error messages
   - Log errors comprehensively

8. **Input validation**
   - Sanitize user input
   - Validate formats (emails, paths, etc.)
   - Prevent command injection

---

## VERIFICATION FAILURES = DO NOT COMMIT

If ANY of these checks fail:
1. **FIX the code immediately**
2. **Re-run ALL verification steps**
3. **Do NOT commit until everything passes**

Pushing broken code to main is unacceptable. The verification steps exist to prevent exactly this.

### Common Bash Pitfalls to Avoid

1. **SC2155**: Declare and assign separately

   ```bash
   # Bad
   local var=$(command)
   
   # Good
   local var
   var=$(command) || handle_error
   ```

2. **Filename handling**: Use null delimiters

   ```bash
   # Bad
   find . -type f | while read file; do

   # Good
   while IFS= read -r -d '' file; do
       ...
   done < <(find . -type f -print0)
   ```

3. **Unused variables**: Remove them or document why they're there

4. **Input sanitization**: Always validate and sanitize user input

   ```bash
   # Validate format
   [[ "$email" =~ ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]] || return_error

   # Sanitize metacharacters
   email="${email//[;<>\`\$\(\)]/}"
   ```

### Before Creating a PR

Use the comprehensive checklist from [STYLE_GUIDE.md § Enforcement](./STYLE_GUIDE.md#enforcement):

1. ✅ All linter warnings addressed (zero warnings)
2. ✅ Syntax validated (`bash -n script.sh`)
3. ✅ Edge cases considered and documented
4. ✅ Error handling tested where possible
5. ✅ Code follows project conventions
6. ✅ Commit messages are descriptive
7. ✅ All scripts < 400 lines
8. ✅ Help text is comprehensive (man-page style)
9. ✅ Timer and display requirements met
10. ✅ Platform-specific code tested

**See [STYLE_GUIDE.md § Comprehensive Pre-Commit Validation Checklist](./STYLE_GUIDE.md#comprehensive-pre-commit-validation-checklist) for complete list.**

### Creating Pull Requests

Always provide a PR URL at the end of every work session that involves code changes.

When in Web mode (where `gh` CLI is unavailable):

1. Provide the direct GitHub compare URL for PR creation
2. Format: `https://github.com/OWNER/REPO/compare/BASE...BRANCH?expand=1`
3. Include pre-written title and description for user to paste
4. Provide this URL before the session ends

**Example:**

```text
https://github.com/bordenet/scripts/compare/main...claude/feature-branch?expand=1
```

---

## Critical Workflow: Impact Analysis Before ANY Change

**MANDATORY**: Before making ANY change (especially deletions), perform complete impact analysis.

### When Deleting or Renaming Files

**ALWAYS follow this exact sequence:**

1. **Search for ALL references FIRST** (before any changes):
   ```bash
   # Search across all files
   grep -r "FILENAME" --include="*.md" --include="*.sh" .

   # Check for broken links that will result
   ./validate-cross-references.sh
   ```

2. **Identify ALL affected files**:
   - Documentation files (README.md, Agents.md, STYLE_GUIDE.md, docs/*)
   - Scripts that source or reference the file
   - Configuration files
   - CI/CD workflows

3. **Plan atomic commit**:
   - List ALL files that need updates
   - Ensure all changes happen in ONE commit
   - Never commit a deletion without updating all references

4. **Make ALL changes together**:
   - Delete/rename the target file
   - Update ALL referencing files
   - Fix ALL broken links
   - Update related documentation

5. **Validate BEFORE committing**:
   ```bash
   # Verify file is gone (if deleting)
   test -f FILENAME && echo "ERROR: Still exists" || echo "OK: Deleted"

   # Verify no references remain
   grep -r "FILENAME" --include="*.md" --include="*.sh" . || echo "OK: No references"

   # Run validation scripts
   ./validate-cross-references.sh
   ./validate-script-compliance.sh
   ```

6. **Only then commit**

### When Updating Documentation

**ALWAYS verify completeness:**

1. **Before editing README.md**, check what's missing:
   ```bash
   # List all root-level scripts
   ls -1 *.sh 2>/dev/null | sort

   # Compare against README.md
   grep "\.sh" README.md | grep -o '[a-z0-9-]*\.sh' | sort
   ```

2. **Identify gaps**:
   - Scripts not documented
   - Outdated descriptions
   - Broken links
   - Missing categories

3. **Fix everything in one commit**:
   - Add missing scripts
   - Update descriptions
   - Fix broken links
   - Ensure alphabetical ordering within categories

### Validation Tools in This Repository

**USE THESE BEFORE EVERY COMMIT:**

- `./validate-cross-references.sh` - Validates all markdown links and cross-references
- `./validate-script-compliance.sh` - Validates scripts against STYLE_GUIDE.md
- `./ci-quality-gates.sh` - Runs all CI checks locally

**Example pre-commit workflow:**

```bash
# 1. Make your changes
# 2. Validate everything
./validate-cross-references.sh
./validate-script-compliance.sh

# 3. Check for broken references to files you changed
grep -r "CHANGED_FILENAME" --include="*.md" --include="*.sh" .

# 4. Only then commit
git add -A
git commit -m "Description"
```

### Lessons Learned: Real Failures

**Failure Case 1: Incomplete deletion (2025-11-25)**
- **What happened**: Deleted TECHNICAL_DEBT.md without checking references
- **Impact**: Left broken links in README.md and Agents.md
- **Root cause**: Didn't search for references before deletion
- **Prevention**: ALWAYS `grep -r "FILENAME"` before deleting

**Failure Case 2: Incomplete documentation (2025-11-25)**
- **What happened**: Updated README.md without checking completeness
- **Impact**: 5 user-facing scripts undocumented
- **Root cause**: Didn't compare `ls *.sh` against README.md
- **Prevention**: ALWAYS audit completeness when editing documentation

**Failure Case 3: `set -euo pipefail` abort (2025-11-29)**
- **What happened**: `fetch-github-projects.sh --all` aborted immediately after showing "Updating CallBox..."
- **Impact**: Script terminated with non-zero exit code, user's workflow broken
- **Root cause**: The pipeline `git remote show origin 2>/dev/null | awk '/HEAD branch/ {print $NF}'` failed silently when the network command failed. With `pipefail`, the entire script aborted.
- **Similar issues found in**: 6 scripts with `stop_timer()` functions using bare `kill`/`wait` commands
- **Prevention**:
  - ALWAYS add `|| true` to network-dependent pipelines that shouldn't abort the script
  - ALWAYS add `|| true` to `kill` and `wait` commands in cleanup functions
  - ALWAYS test scripts with simulated network failures
  - See [STYLE_GUIDE.md § Surviving `set -euo pipefail`](./STYLE_GUIDE.md#surviving-set--euo-pipefail) for patterns

**Failure Case 4: Missing variable export breaks production (2025-11-29)**
- **What happened**: Added real-time progress feature using `$CYAN` color variable in lib/bu-lib.sh
- **Impact**: Script crashed immediately with "CYAN: unbound variable" when run with `set -u`
- **Root cause**: Added code using `$CYAN` in library but failed to export `CYAN` in calling script (bu.sh)
- **Prevention**:
  - **MANDATORY**: Actually RUN the script before committing, don't just check syntax
  - Test library changes: `bash -c 'export VAR1=val; source lib/file.sh; function_name'`
  - With `set -u`, missing exports cause immediate failure - this is catchable by running the script
  - **NO EXCEPTIONS**: If you modify a library, you MUST test it by actually calling it
  - This failure was 100% preventable by running `./bu.sh --help` before committing

**Failure Case 5: Widespread STYLE_GUIDE.md non-compliance (2025-11-29)**
- **What happened**: User discovered fetch-github-projects.sh lacked --verbose flag (STYLE_GUIDE.md requirement)
- **Impact**: Audit revealed 24 out of 30 scripts (80%) lacked mandatory --verbose flag
- **Root cause**:
  - STYLE_GUIDE.md added --verbose requirement but never enforced retroactively
  - Agents.md pre-commit checklist didn't explicitly verify --verbose presence
  - validate-script-compliance.sh didn't catch this violation
  - Scripts were grandfathered in without compliance audit
- **Prevention**:
  - **MANDATORY**: Pre-commit checklist step 1 now verifies STYLE_GUIDE.md compliance
  - Explicit checks for: `-h/--help`, `-v/--verbose`, `--what-if` (destructive scripts)
  - When adding new requirements to STYLE_GUIDE.md, MUST audit ALL existing scripts
  - When adding new requirements to STYLE_GUIDE.md, MUST update validate-script-compliance.sh
  - **NO EXCEPTIONS**: New scripts MUST pass all STYLE_GUIDE.md requirements before first commit

### The Golden Rule of Changes

**NEVER make a change in isolation. ALWAYS:**

1. ✅ Search for ALL impacts FIRST
2. ✅ Plan ALL related changes
3. ✅ Make ALL changes atomically
4. ✅ Validate BEFORE committing
5. ✅ Run validation scripts

**If you skip any step, you WILL create broken references, incomplete documentation, or inconsistent state.**

---

## Comprehensive Pre-Push Audit Checklist

**MANDATORY**: Run this complete audit before pushing to `origin/main` or creating any pull request. This is a SCRIPTS repository - quality gates must be 100% clean.

### When to Run This Audit

- Before pushing to `origin/main`
- After completing a major feature or refactor
- After making changes that affect multiple scripts
- When preparing for a release
- **Periodically** (at least monthly) to catch drift

### The Complete Audit Process

```bash
# 1. SYNTAX VALIDATION - Every script must parse correctly
find . -type f -name "*.sh" -exec bash -n {} \; 2>&1
# Expected: None (silence means success)
# Fix syntax errors immediately if found

# 2. SHELLCHECK VALIDATION - Zero warnings at -S warning level
for script in $(find . -type f -name "*.sh"); do
  shellcheck -S warning "$script" 2>&1 | grep -q "^In " && echo "FAIL: $script"
done
# Expected: None
# Fix all shellcheck warnings if found

# 3. CROSS-REFERENCE VALIDATION - All markdown links must be valid
./validate-cross-references.sh
# Expected: "All cross-references are valid"
# Fix broken links atomically with changes

# 4. LINE COUNT VALIDATION - No script > 400 lines
find . -type f -name "*.sh" -exec wc -l {} + | awk '$1 > 400 {print "FAIL:", $2, "("$1" lines)"}'
# Expected: None
# Refactor oversized scripts into lib/ modules

# 5. PIPEFAIL PATTERN VALIDATION - Network commands need || true
grep -r "git remote show origin\|curl.*|" --include="*.sh" . | grep -v "|| true" | grep "set -euo pipefail"
# Expected: None
# Add || true to network-dependent pipelines

# 6. KILL/WAIT VALIDATION - Cleanup functions need || true
for script in $(grep -l "set -euo pipefail" *.sh **/*.sh 2>/dev/null); do
  grep -H "kill \|wait " "$script" | grep -v "|| true" && echo "CHECK: $script"
done
# Expected: Only scripts without pipefail (mu.sh, lib files)
# Add || true to kill/wait in pipefail scripts

# 7. EXIT CODE CAPTURE VALIDATION - $? captured immediately
grep -rn "exit_code=\$?" --include="*.sh" .
# Manually verify: must be first statement after command
# Fix if suspicious context

# 8. SOURCED FILE VALIDATION - All libraries exist
for script in $(find . -type f -name "*.sh"); do
  grep "^source \|^\. " "$script" 2>/dev/null | while read -r line; do
    file=$(echo "$line" | awk '{print $2}' | tr -d '"')
    [ -f "$file" ] || echo "MISSING: $file (in $script)"
  done
done
# Expected: None
# Fix source paths or create libraries

# 9. DOCUMENTATION COMPLETENESS - User scripts in README
comm -23 <(ls -1 *.sh 2>/dev/null | sort) <(grep "\.sh" README.md | grep -o '[a-z0-9-]*\.sh' | sort)
# Expected: Only lib/internal scripts
# Add user-facing scripts to README.md

# 10. TODO/FIXME AUDIT - All TODOs documented
grep -rn "TODO\|FIXME" --include="*.sh" . | grep -v "git-rebase-todo"
# Review each: explained? ticket? can fix now?
```

### What to Do When Checks Fail

**DO NOT commit until ALL checks pass.** This is non-negotiable.

1. **Fix the issue** - Don't work around it
2. **Understand root cause** - Why did this happen?
3. **Update checklist if needed** - Missing a pattern?
4. **Re-run full audit** - Fixes can introduce new issues

### Quick Validation During Development

```bash
# Fast check before each commit
bash -n script.sh && shellcheck -S warning script.sh
```

### Recording Audit Results

```bash
# After successful audit, create timestamp
date "+%Y-%m-%d %H:%M:%S" > .last-audit
git add .last-audit
git commit -m "chore: Complete pre-push audit - all gates pass"
```

---

## Superpowers Skills

At the START of every conversation, run:

```bash
node ~/.codex/superpowers-augment/superpowers-augment.js bootstrap
```

This loads available skills. Key skills:
- `superpowers:brainstorming` - Before creative/feature work
- `superpowers:systematic-debugging` - Before fixing bugs
- `superpowers:test-driven-development` - Before writing implementation
- `superpowers:verification-before-completion` - Before claiming done
- `superpowers:writing-plans` - Before multi-step tasks

**To load a skill:**
```bash
node ~/.codex/superpowers-augment/superpowers-augment.js use-skill superpowers:<skill-name>
```

**To list all skills:**
```bash
node ~/.codex/superpowers-augment/superpowers-augment.js find-skills
```

**The Rule:** IF A SKILL APPLIES TO YOUR TASK (even 1% chance), YOU MUST INVOKE IT.

---

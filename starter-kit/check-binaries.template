#!/usr/bin/env bash
################################################################################
# Binary Check Hook Template
################################################################################
# PURPOSE: Prevent compiled binaries from being committed to the repository
#
# USAGE: Copy to .husky/check-binaries and customize for your project
#
# Binaries are platform-specific and should be built from source.
# This hook checks staged files for:
# - Mach-O executables (macOS)
# - ELF executables (Linux)
# - PE executables (Windows)
# - Files matching known binary patterns
################################################################################

set -e

# ANSI color codes
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo "ðŸ” Checking for compiled binaries..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo "âœ… No files staged for commit"
    exit 0
fi

# Arrays to track issues
BINARIES_FOUND=()

# Check each staged file
while IFS= read -r file; do
    # Skip if file doesn't exist (might be deleted)
    if [ ! -f "$file" ]; then
        continue
    fi

    # Get file type
    FILE_TYPE=$(file -b "$file" 2>/dev/null || echo "unknown")

    # Check for executable binaries
    if echo "$FILE_TYPE" | grep -qiE "(executable|Mach-O|ELF|PE32|shared object)"; then
        # Exclude shell scripts and other text-based executables
        if ! echo "$FILE_TYPE" | grep -qiE "(shell script|text|ASCII)"; then
            BINARIES_FOUND+=("$file")
        fi
    fi

    # CUSTOMIZE: Check for known binary patterns in your project
    # Example: Go tool binaries
    if echo "$file" | grep -qE "^tools/[^/]+/[^/]+$" && [ -x "$file" ]; then
        DIR=$(dirname "$file")
        FILENAME=$(basename "$file")
        DIR_NAME=$(basename "$DIR")

        # Check if filename matches directory (common Go binary pattern)
        if [ "$FILENAME" = "$DIR_NAME" ] || [ "$FILENAME" = "${DIR_NAME}-go" ]; then
            # Verify it's actually a binary
            if ! file "$file" | grep -qiE "(text|ASCII|shell script)"; then
                BINARIES_FOUND+=("$file")
            fi
        fi
    fi

    # CUSTOMIZE: Check for root-level binaries
    if [ "$(dirname "$file")" = "." ] && [ -x "$file" ]; then
        # Add your binary names here
        if echo "$file" | grep -qE "^(validator|cli-tool|app-binary)$"; then
            BINARIES_FOUND+=("$file")
        fi
    fi

done <<< "$STAGED_FILES"

# Report findings
if [ ${#BINARIES_FOUND[@]} -gt 0 ]; then
    echo ""
    echo -e "${RED}âŒ ERROR: Compiled binaries detected in staged files${NC}"
    echo ""
    echo "The following binaries should NOT be committed:"
    echo ""
    for binary in "${BINARIES_FOUND[@]}"; do
        echo -e "  ${RED}âœ—${NC} $binary"
    done
    echo ""
    echo "Binaries are platform-specific and should be built from source."
    echo ""
    echo "To fix this:"
    echo "  1. Unstage the binary files:"
    for binary in "${BINARIES_FOUND[@]}"; do
        echo "     git reset HEAD $binary"
    done
    echo ""
    echo "  2. Ensure they're in .gitignore"
    echo "  3. Remove from repository if already tracked:"
    echo "     git rm --cached <file>"
    echo ""
    exit 1
fi

echo -e "${GREEN}âœ… No binaries detected${NC}"
exit 0

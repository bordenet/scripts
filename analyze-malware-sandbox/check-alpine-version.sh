#!/usr/bin/env bash
################################################################################
# Script Name: check-alpine-version.sh
# Description: Check if Alpine Linux version is latest
# Platform: macOS/Linux
# Author: Matt J Bordenet
# Last Updated: 2025-11-21
################################################################################

set -euo pipefail

# Display help information
show_help() {
    cat << EOF
NAME
    $(basename "$0") - Check if Alpine Linux version is latest

SYNOPSIS
    $(basename "$0") [OPTIONS]

DESCRIPTION
    Checks if the Alpine Linux version specified in setup-sandbox.sh is the
    latest stable version available from the official Alpine Linux website.

    Compares the configured version against the latest release and provides
    update instructions if a newer version is available.

OPTIONS
    -h, --help
        Display this help message and exit

EXAMPLES
    # Check version
    $(basename "$0")

EXIT STATUS
    0   Success
    1   Error (setup-sandbox.sh not found, network error, etc.)

FILES
    setup-sandbox.sh
        Configuration file containing ALPINE_VERSION variable

    alpine.iso
        Downloaded Alpine Linux ISO file

NOTES
    - Requires curl for fetching latest version info
    - Scrapes alpinelinux.org/downloads/ for version info
    - Provides instructions for updating to new version

SEE ALSO
    setup-sandbox.sh(1), curl(1)

EOF
    exit 0
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            show_help
            ;;
        *)
            echo "Error: Unknown option: $1" >&2
            echo "Use --help for usage information" >&2
            exit 1
            ;;
    esac
done

# --- Script Setup ---
start_time=$(date +%s)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# --- Main Script ---
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "  Alpine Linux Version Check"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Get the currently configured version from the setup script.
if [ -f "setup-sandbox.sh" ]; then
    CURRENT_VERSION=$(grep "^ALPINE_VERSION=" setup-sandbox.sh | cut -d'"' -f2 | head -1)
    echo "Current version configured in setup-sandbox.sh: $CURRENT_VERSION"
else
    echo "Error: setup-sandbox.sh not found. Cannot determine current version."
    exit 1
fi

echo ""
echo "Checking Alpine Linux website for the latest stable version..."
echo ""

# Scrape the downloads page for the latest version number.
# Use || true to prevent pipefail from aborting script on network failures
LATEST_VERSION_RAW=$(curl -s https://alpinelinux.org/downloads/ | grep -o "alpine-virt-[0-9]\+\.[0-9]\+\.[0-9]\+-x86_64.iso" | head -1 || true)
LATEST_VERSION=$(echo "$LATEST_VERSION_RAW" | sed 's/alpine-virt-//' | sed 's/-x86_64.iso//')

if [ -n "$LATEST_VERSION" ]; then
    echo "Latest stable version available: $LATEST_VERSION"
    if [ "$CURRENT_VERSION" == "$LATEST_VERSION" ]; then
        echo "âœ… You are using the latest version."
    else
        echo "âš ï¸ A newer version is available."
    fi
else
    echo "âŒ Could not determine the latest version from the Alpine Linux website."
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

if [ -f "alpine.iso" ]; then
    LOCAL_SIZE=$(ls -lh alpine.iso | awk '{print $5}')
    echo "âœ… Local alpine.iso exists ($LOCAL_SIZE)"
else
    echo "âŒ No alpine.iso found - run ./setup-sandbox.sh to download"
fi

echo ""
echo "ğŸ“ To update to a new version:"
echo "   1. Edit setup-sandbox.sh"
# The following line has been corrected to properly escape the double quote within the string.
echo "   2. Change ALPINE_VERSION=\"$CURRENT_VERSION\" to the new version"
echo "   3. Remove alpine.iso: rm alpine.iso"
echo "   4. Run ./setup-sandbox.sh to download the new version"

echo ""
echo "ğŸ”— Manual check: https://alpinelinux.org/downloads/"
echo ""

# --- Completion ---
end_time=$(date +%s)
execution_time=$((end_time - start_time))
echo "Execution time: ${execution_time} seconds"

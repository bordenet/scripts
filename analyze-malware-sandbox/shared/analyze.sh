#!/bin/bash
# -----------------------------------------------------------------------------
#
# Script Name: analyze.sh
#
# Description: This script runs inside the Alpine Linux VM to analyze
#              potentially malicious files. It can install a suite of analysis
#              tools and then perform a multi-faceted scan of a target file.
#
# Usage:
#   ./analyze.sh install-tools   - Installs all required analysis tools.
#   ./analyze.sh scan <file>     - Scans the specified file.
#
# Author: Matt J Bordenet
#
# Last Updated: 2025-10-08
#
# -----------------------------------------------------------------------------

# Exit on error, undefined variable, or pipe failure
set -euo pipefail

# --- Configuration ---
TOOLS_INSTALLED_MARKER="/root/.analysis_tools_installed"

# --- Functions ---

# Install analysis tools
install_tools() {
    start_time=$(date +%s)
    echo "========================================="
    echo "  Installing Analysis Tools"
    echo "========================================="
    echo ""

    echo "ğŸ“¦ Updating package repository..."
    apk update

    echo "ğŸ”§ Installing analysis tools..."
    apk add \
        file \
        binutils \
        strings \
        hexyl \
        clamav \
        clamav-daemon \
        freshclam \
        python3 \
        py3-pip \
        unzip \
        p7zip \
        cabextract \
        unrar \
        sqlite \
        exiftool \
        imagemagick \
        poppler-utils \
        yara \
        ssdeep \
        radare2

    echo "ğŸ¦  Updating ClamAV virus database (this may take a few minutes)..."
    freshclam || echo "âš ï¸  ClamAV database update had issues, continuing anyway..."

    echo "ğŸ”§ Installing Python analysis tools..."
    pip3 install --break-system-packages \
        oletools \
        pefile \
        yara-python \
        ssdeep \
        python-magic

    # Create marker file
    touch "${TOOLS_INSTALLED_MARKER}"

    echo ""
    echo "âœ… All analysis tools installed successfully!"
    end_time=$(date +%s)
    execution_time=$((end_time - start_time))
    echo "Installation time: ${execution_time} seconds."
}

# Scan a file
scan_file() {
    start_time=$(date +%s)
    local target="$1"

    if [ ! -e "${target}" ]; then
        echo "âŒ File not found: ${target}"
        exit 1
    fi

    echo "========================================="
    echo "  Malware Analysis Report"
    echo "========================================="
    echo "  Target: ${target}"
    echo "  Date:   $(date)"
    echo "========================================="
    echo ""

    # Check if tools are installed
    if [ ! -f "${TOOLS_INSTALLED_MARKER}" ]; then
        echo "âš ï¸  Analysis tools not installed. Installing now..."
        install_tools
        echo ""
    fi

    # Basic file information
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“„ FILE INFORMATION"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "File type:"
    file -b "${target}"
    echo ""
    echo "File size:"
    ls -lh "${target}" | awk '{print $5}'
    echo ""
    echo "MD5:    $(md5sum "${target}" | awk '{print $1}')"
    echo "SHA1:   $(sha1sum "${target}" | awk '{print $1}')"
    echo "SHA256: $(sha256sum "${target}" | awk '{print $1}')"
    echo ""

    # Metadata extraction
    if command -v exiftool &>/dev/null; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“‹ METADATA (EXIF)"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        exiftool "${target}" || echo "Could not extract metadata"
        echo ""
    fi

    # ClamAV scan
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ¦  CLAMAV VIRUS SCAN"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    if clamscan "${target}"; then
        echo "âœ… No malware detected by ClamAV"
    else
        echo "âš ï¸  ClamAV detected potential threats!"
    fi
    echo ""

    # String extraction
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ”¤ INTERESTING STRINGS"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "URLs and domains:"
    strings "${target}" | grep -E '(https?://|www\.|[a-zA-Z0-9][-a-zA-Z0-9]+\.(com|net|org|io|ru|cn))' | head -20 || echo "None found"
    echo ""
    echo "Email addresses:"
    strings "${target}" | grep -E '[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}' | head -10 || echo "None found"
    echo ""
    echo "IP addresses:"
    strings "${target}" | grep -E '([0-9]{1,3}\.){3}[0-9]{1,3}' | head -10 || echo "None found"
    echo ""
    echo "Suspicious keywords:"
    strings "${target}" | grep -iE '(password|pass|pwd|exec|eval|shell|cmd|payload|exploit|malware)' | head -10 || echo "None found"
    echo ""

    # Office document analysis (if applicable)
    if file "${target}" | grep -qiE '(microsoft|office|ooxml|opendocument)'; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“ OFFICE DOCUMENT ANALYSIS"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        if command -v olevba &>/dev/null; then
            echo "Analyzing macros with olevba..."
            olevba "${target}" || echo "Could not analyze macros"
        fi
        if command -v oleid &>/dev/null; then
            echo ""
            echo "Analyzing with oleid..."
            oleid "${target}" || echo "Could not analyze with oleid"
        fi
        echo ""
    fi

    # PDF analysis (if applicable)
    if file "${target}" | grep -qi 'pdf'; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“• PDF ANALYSIS"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        if command -v pdfinfo &>/dev/null; then
            echo "PDF Information:"
            pdfinfo "${target}" || echo "Could not extract PDF info"
        fi
        echo ""
        echo "Checking for JavaScript in PDF:"
        strings "${target}" | grep -i 'javascript' || echo "None found"
        echo ""
    fi

    # PE executable analysis (if applicable)
    if file "${target}" | grep -qiE '(PE32|MS-DOS)'; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âš™ï¸  EXECUTABLE ANALYSIS"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "Imports and exports:"
        readelf -a "${target}" 2>/dev/null | head -50 || strings "${target}" | grep -iE '(kernel32|ntdll|advapi|user32)' | head -20 || echo "Could not analyze"
        echo ""
    fi

    # Hex dump (first 512 bytes)
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ”¢ HEX DUMP (first 512 bytes)"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    if command -v hexyl &>/dev/null; then
        hexyl -n 512 "${target}"
    else
        hexdump -C "${target}" | head -32
    fi
    echo ""

    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âœ… Analysis complete!"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    end_time=$(date +%s)
    execution_time=$((end_time - start_time))
    echo "Scan time: ${execution_time} seconds."
}

# Show usage
usage() {
    cat <<EOF
Usage: $0 <command> [arguments]

Commands:
  install-tools           Install all analysis tools
  scan <file>            Scan a file for malware
  help                   Show this help message

Examples:
  $0 install-tools
  $0 scan /media/shared/suspicious.exe
  $0 scan /media/shared/document.pdf
EOF
}

# Main function
main() {
    start_time=$(date +%s)
    if [ $# -eq 0 ]; then
        usage
        exit 1
    fi

    case "$1" in
        install-tools)
            install_tools
            ;; 
        scan)
            if [ $# -lt 2 ]; then
                echo "Error: scan command requires a file path"
                usage
                exit 1
            fi
            scan_file "$2"
            ;; 
        help)
            usage
            ;; 
        *)
            echo "Error: Unknown command '$1'"
            usage
            exit 1
            ;; 
    esac
    end_time=$(date +%s)
    execution_time=$((end_time - start_time))
    echo "Total script execution time: ${execution_time} seconds."
}

main "$@"